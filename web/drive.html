<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>LocalCloud â€” Mobile (Folders + Files + Download)</title>
<meta name="color-scheme" content="light dark">
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --accent:#0b6cff;
  --gap:12px; --radius:12px; --shadow:0 8px 22px rgba(8,12,30,0.06);
  --tap:56px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#071031;-webkit-font-smoothing:antialiased}
.app{min-height:100vh;display:flex;flex-direction:column}

/* topbar */
.top{position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:8px;padding:10px;background:linear-gradient(90deg,#07203a,#0a2540);color:#fff}
.brand{font-weight:700;font-size:16px;min-width:40px}
.search{flex:1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.06);padding:6px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
.search input{flex:1;border:0;background:transparent;padding:10px 6px;color:#fff;font-size:16px;outline:none}
.icon{background:var(--card);border-radius:10px;padding:8px;min-width:44px;min-height:44px;display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer}

/* breadcrumb */
.header-strip{display:flex;align-items:center;gap:8px;padding:8px 10px;background:transparent}
.back{font-size:14px;color:var(--muted);padding:6px 8px;border-radius:8px;background:transparent;border:0;cursor:pointer}

/* content */
.container{flex:1;overflow:auto;padding:10px}
.section-title{font-weight:700;margin:8px 0;color:#0b1220;display:flex;align-items:center;justify-content:space-between}
.folder-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:8px}
.folder-tile{background:var(--card);border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;padding:6px}
.folder-thumb{width:100%;height:110px;object-fit:cover;background:#eef3ff;border-radius:8px;display:flex;align-items:center;justify-content:center}
.folder-name{margin-top:8px;font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.card{background:var(--card);border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow);display:flex;flex-direction:column}
.thumb{width:100%;height:120px;object-fit:cover;background:#eef3ff}
.meta{padding:8px;font-size:13px}
.meta .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.muted{color:var(--muted);font-size:12px}

/* empty state */
.empty{padding:22px;border-radius:12px;background:var(--card);text-align:center;color:var(--muted);box-shadow:var(--shadow);margin-top:8px}

/* modal viewer */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;padding:12px;z-index:999;visibility:hidden;opacity:0;transition:opacity .12s}
.modal.show{visibility:visible;opacity:1}
.viewer{width:100%;max-width:960px;background:#000;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.viewer img,.viewer video{max-width:100%;max-height:78vh;border-radius:8px}
.viewer .meta{color:#e8eefc;font-size:13px}

/* bottom bar */
.bottom-bar{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.01));padding:10px;display:flex;gap:8px;justify-content:space-between;align-items:center;z-index:30}

/* responsive */
@media(min-width:720px){
  .folder-grid{grid-template-columns:repeat(4,1fr)}
  .grid{grid-template-columns:repeat(4,1fr)}
  .thumb{height:140px}
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="LocalCloud Mobile">
    <header class="top" role="banner">
      <div class="brand">LocalCloud</div>
      <div class="search" role="search">
        <input id="searchInput" placeholder="Search photos & videos (name, date, camera)" aria-label="Search"/>
        <button id="clearBtn" class="icon" title="Clear">âœ•</button>
      </div>
      <button id="refreshBtn" class="icon" title="Refresh">âŸ³</button>
    </header>

    <div class="header-strip">
      <button id="backBtn" class="back" aria-label="Back">â—€ Back</button>
      <div id="breadcrumb" style="font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">/</div>
      <!-- Download current folder as zip -->
      <button id="downloadAllBtn" class="icon" title="Download all">â¤“</button>
    </div>

    <main class="container" id="container" role="main">
      <!-- Folders (top) -->
      <div id="foldersSection">
        <div class="section-title">
          <div>Folders</div>
        </div>
        <div id="folderGrid" class="folder-grid" aria-live="polite"></div>
      </div>

      <!-- Files -->
      <div class="section-title">
        <div>Files</div>
      </div>
      <div id="grid" class="grid" role="list" aria-live="polite"></div>

      <div id="empty" class="empty" style="display:none">No files found â€” try a different search or open another directory.</div>
      <div style="text-align:center;padding:12px"><button id="loadMore" class="icon">Load more</button></div>
    </main>

    <div class="bottom-bar">
      <div id="resultCount" style="color:var(--muted);font-size:13px">â€”</div>
      <div style="display:flex;gap:8px">
        <button id="openSearchBtn" class="icon" title="Focus search">ðŸ”Ž</button>
      </div>
    </div>

    <div id="modal" class="modal" aria-hidden="true" onclick="closeModal()">
      <div class="viewer" onclick="event.stopPropagation()">
        <div id="mediaArea"></div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px">
            <button id="prevBtn" class="icon">Prev</button>
            <button id="nextBtn" class="icon">Next</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <!-- Single file download -->
            <a id="downloadFileBtn" class="icon" href="#" target="_blank" rel="noopener noreferrer" title="Download">â¤“</a>
          </div>
        </div>

        <pre id="viewerMeta" class="viewer-meta" style="color:#e8eefc;font-size:12px;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

<script>
/* Mobile UI with Download buttons (single-file and folder-zip) */

const PAGE_SIZE = 60;
let currentPath = '/';
let offset = 0;
let items = [];
let folders = [];
let loading = false;
let currentIndex = -1;

/* DOM refs */
const folderGrid = document.getElementById('folderGrid');
const gridEl = document.getElementById('grid');
const searchInput = document.getElementById('searchInput');
const clearBtn = document.getElementById('clearBtn');
const loadMoreBtn = document.getElementById('loadMore');
const backBtn = document.getElementById('backBtn');
const breadcrumbEl = document.getElementById('breadcrumb');
const resultCount = document.getElementById('resultCount');
const refreshBtn = document.getElementById('refreshBtn');
const openSearchBtn = document.getElementById('openSearchBtn');
const emptyEl = document.getElementById('empty');

const downloadAllBtn = document.getElementById('downloadAllBtn');

/* modal elements */
const modal = document.getElementById('modal');
const mediaArea = document.getElementById('mediaArea');
const viewerMeta = document.getElementById('viewerMeta');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const downloadFileBtn = document.getElementById('downloadFileBtn');

let ioObserver = null;

/* helpers */
function normalizePath(p){
  if(!p) return '/';
  if(!p.startsWith('/')) p = '/'+p;
  if(p.length>1 && p.endsWith('/')) p = p.slice(0,-1);
  return p;
}
function thumbUrl(path,w=360){ return `/api/thumbnail?path=${encodeURIComponent(path)}&w=${w}`; }
function fileUrl(path){ return `/api/file?path=${encodeURIComponent(path)}`; }
function zipUrl(path){ return `/api/download-zip?path=${encodeURIComponent(path)}`; }
function singleDownloadUrl(path){ return `/api/download?path=${encodeURIComponent(path)}`; }
function setCount(n){ resultCount.textContent = n + (n===1 ? ' item' : ' items'); }
function esc(s){ return String(s||''); }

/* debounce */
function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* lazy loader */
function ensureObserver(){
  if(ioObserver) return;
  ioObserver = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      if(en.isIntersecting){
        const img = en.target;
        if(img.dataset && img.dataset.src){ img.src = img.dataset.src; delete img.dataset.src; }
        ioObserver.unobserve(img);
      }
    });
  }, {root: document.getElementById('container'), rootMargin: '300px'});
}

/* folder SVG data URI */
const FOLDER_SVG_URI = "data:image/svg+xml;utf8," + encodeURIComponent(
  '<svg xmlns="http://www.w3.org/2000/svg" width="512" height="384" viewBox="0 0 24 18" fill="none">' +
  '<rect width="24" height="18" rx="2" fill="%23eef3ff"/>' +
  '<path d="M2 7h8l2 2h10v6a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1z" fill="%23cfe7ff"/>' +
  '<path d="M2 7h8l2-2h7a1 1 0 0 1 1 1v2H2z" fill="%23fff" opacity="0.9"/>' +
  '</svg>'
);

/* render folder tile (folder icon always) */
function createFolderTile(folder){
  const tile = document.createElement('div'); tile.className = 'folder-tile'; tile.tabIndex = 0;
  const thumb = document.createElement('div'); thumb.className = 'folder-thumb';
  const img = document.createElement('img');
  img.alt = folder.name;
  img.src = FOLDER_SVG_URI;
  img.style.width = '60%';
  img.style.height = '60%';
  img.style.objectFit = 'contain';
  img.style.borderRadius = '6px';
  thumb.appendChild(img);

  const name = document.createElement('div'); name.className = 'folder-name'; name.textContent = folder.name;
  tile.appendChild(thumb); tile.appendChild(name);
  tile.onclick = ()=> navigateTo(folder.path);
  return tile;
}

/* render file card */
function createCard(item, idx){
  const div = document.createElement('div'); div.className = 'card'; div.tabIndex = 0;
  div.onclick = ()=> openViewer(idx);
  const img = document.createElement('img'); img.className = 'thumb'; img.alt = item.name || '';
  img.dataset.src = item.thumb || thumbUrl(item.path, 360);
  img.loading = 'lazy';
  const meta = document.createElement('div'); meta.className = 'meta';
  meta.innerHTML = `<div class="name">${esc(item.name)}</div><div class="muted">${item.modified? new Date(item.modified).toLocaleString() : ''}</div>`;
  div.appendChild(img); div.appendChild(meta);
  return div;
}

/* load current path (folders + files) */
async function loadPath(path, off=0, limit=PAGE_SIZE, replace=true){
  if(loading) return;
  loading = true;
  if(replace){
    gridEl.innerHTML = '';
    folderGrid.innerHTML = '';
    items = [];
    folders = [];
  }
  try{
    const res = await fetch(`/api/grid?path=${encodeURIComponent(path)}&offset=${off}&limit=${limit}`);
    if(!res.ok) throw new Error('grid error');
    const j = await res.json();
    const all = j.items || [];
    const folderItems = all.filter(it => it.type === 'dir');
    const fileItems = all.filter(it => it.type === 'file');

    folderItems.forEach(f => {
      folders.push(f);
      const t = createFolderTile(f);
      folderGrid.appendChild(t);
    });

    const startIndex = items.length;
    fileItems.forEach((fi, i) => {
      const idx = startIndex + i;
      items.push(fi);
      const c = createCard(fi, idx);
      gridEl.appendChild(c);
    });

    ensureObserver();
    document.querySelectorAll('[data-src]').forEach(img => ioObserver.observe(img));
    setCount(folderItems.length + items.length);
    emptyEl.style.display = (folderItems.length + items.length === 0) ? 'block' : 'none';
    loadMoreBtn.style.display = (fileItems.length < limit) ? 'none' : 'inline-block';
  }catch(e){
    console.error('loadPath', e);
  } finally { loading = false; }
}

/* search (single box) */
const doSearch = debounce(async function(q){
  if(!q || q.trim() === ''){ navigateTo('/'); return; }
  gridEl.innerHTML = ''; folderGrid.innerHTML = ''; items = []; folders = []; currentIndex = -1;
  try{
    const res = await fetch(`/api/search?query=${encodeURIComponent(q)}&limit=500`);
    if(!res.ok){ gridEl.innerHTML = '<div class="empty">Search failed</div>'; return; }
    const j = await res.json();
    const out = j.items || [];
    const folderItems = out.filter(it => it.type === 'dir');
    const fileItems = out.filter(it => !(it.type === 'dir'));
    folderItems.forEach(f => { const t = createFolderTile(f); folderGrid.appendChild(t); folders.push(f); });
    fileItems.forEach((fi, idx) => { items.push(fi); gridEl.appendChild(createCard(fi, items.length-1)); });
    ensureObserver();
    document.querySelectorAll('[data-src]').forEach(img => ioObserver.observe(img));
    setCount(fileItems.length + folderItems.length);
    emptyEl.style.display = (fileItems.length + folderItems.length === 0) ? 'block' : 'none';
    loadMoreBtn.style.display = 'none';
  }catch(e){ console.error('search', e); }
}, 350);

/* navigation */
function setBreadcrumb(p){ breadcrumbEl.textContent = p; }
function navigateTo(p){
  p = normalizePath(p);
  currentPath = p; offset = 0; items = []; folders = []; gridEl.innerHTML = ''; folderGrid.innerHTML = '';
  setBreadcrumb(currentPath);
  history.pushState({path: currentPath}, '', '#'+encodeURIComponent(currentPath));
  loadPath(currentPath, 0, PAGE_SIZE, true);
}

/* viewer */
function openViewer(idx){
  if(idx < 0 || idx >= items.length) return;
  currentIndex = idx;
  const it = items[idx];
  mediaArea.innerHTML = '';
  const mime = it.mime || '';
  if(mime.startsWith('image/') || /\.(jpe?g|png|gif|webp|avif)$/i.test(it.name)){
    const img = document.createElement('img'); img.src = fileUrl(it.path); mediaArea.appendChild(img);
    prefetch(idx+1);
  } else if(mime.startsWith('video/') || /\.(mp4|webm|mov)$/i.test(it.name)){
    const v = document.createElement('video'); v.controls=true; v.autoplay=true; v.src = fileUrl(it.path); mediaArea.appendChild(v);
    prefetch(idx+1);
  } else {
    const a = document.createElement('a'); a.href = fileUrl(it.path); a.textContent = 'Download'; a.target='_blank'; mediaArea.appendChild(a);
  }
  // Set download link for single file (server will set Content-Disposition)
  downloadFileBtn.href = singleDownloadUrl(it.path);
  // download attribute as hint
  try {
    const filename = it.name || it.path.split('/').pop();
    downloadFileBtn.setAttribute('download', filename);
  } catch(e){}
  viewerMeta.textContent = 'Loading metadata...';
  fetch(`/api/metadata?path=${encodeURIComponent(it.path)}`).then(r=>r.ok? r.json() : {}).then(m=>{
    viewerMeta.textContent = m ? JSON.stringify(m, null, 2) : '';
  }).catch(()=>viewerMeta.textContent='');
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
function prefetch(i){ if(i<0||i>=items.length) return; const a=document.createElement('link'); a.rel='prefetch'; a.href=fileUrl(items[i].path); document.head.appendChild(a); }

/* events */
searchInput.addEventListener('input', (e)=> doSearch(e.target.value));
clearBtn.addEventListener('click', ()=> { searchInput.value=''; navigateTo('/'); });
loadMoreBtn.addEventListener('click', ()=> { offset += PAGE_SIZE; loadPath(currentPath, offset, PAGE_SIZE, false); });
backBtn.addEventListener('click', ()=> {
  if(currentPath === '/') return;
  const parts = currentPath.split('/').filter(Boolean);
  parts.pop();
  const parent = parts.length ? '/'+parts.join('/') : '/';
  navigateTo(parent);
});
refreshBtn.addEventListener('click', ()=> navigateTo(currentPath));
openSearchBtn.addEventListener('click', ()=> searchInput.focus());
prevBtn.addEventListener('click', ()=> { if(currentIndex>0) openViewer(currentIndex-1); });
nextBtn.addEventListener('click', ()=> { if(currentIndex < items.length-1) openViewer(currentIndex+1); });

downloadAllBtn.addEventListener('click', ()=>{
  // open zip stream in new tab/window so browser handles the download
  const u = zipUrl(currentPath || '/');
  window.open(u, '_blank');
});

window.addEventListener('popstate', (e)=> { if(e.state && e.state.path) navigateTo(e.state.path); });

document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModal(); if(e.key==='ArrowLeft' && currentIndex>0) openViewer(currentIndex-1); if(e.key==='ArrowRight' && currentIndex<items.length-1) openViewer(currentIndex+1); });

/* init */
(function init(){ navigateTo('/'); ensureObserver(); })();
</script>
</body>
</html>
